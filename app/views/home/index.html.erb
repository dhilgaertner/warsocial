<% content_for :javascript_includes do %>
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache, must-revalidate, max-age=0, no-store" />

    <link rel="stylesheet" type="text/css" href="/css/jquery-ui-1.8.18.custom.css">

    <script src="http://js.pusher.com/1.12/pusher.min.js" type="text/javascript"></script>

    <% if Rails.env.development? || @dev %>
        <script src="/assets/lib/jquery.dataTables.min.js?v=2" type="text/javascript"></script>
        <script src="/assets/lib/customSelect.jquery.js" type="text/javascript"></script>

        <% if !@dev %>
            <script src="/assets/gameboard/communications.js?v=2" type="text/javascript"></script>
            <script src="/assets/gameboard/soundmanager.js?v=2" type="text/javascript"></script>
            <script src="/assets/gameboard/dicebox.js?v=2" type="text/javascript"></script>
            <script src="/assets/gameboard/land.js?v=2" type="text/javascript"></script>
            <script src="/assets/gameboard/map.js?v=2" type="text/javascript"></script>
            <script src="/assets/gameboard/mapcanvas.js?v=2" type="text/javascript"></script>
            <script src="/assets/gameboard/player.js?v=2" type="text/javascript"></script>
            <script src="/assets/gameboard/shared.js?v=2" type="text/javascript"></script>
            <script src="/assets/gameboard/warsocial.js?v=2" type="text/javascript"></script>
        <% else %>
            <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/communications.js?v=4" type="text/javascript"></script>
            <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/soundmanager.js?v=4" type="text/javascript"></script>
            <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/dicebox.js?v=4" type="text/javascript"></script>
            <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/land.js?v=4" type="text/javascript"></script>
            <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/map.js?v=4" type="text/javascript"></script>
            <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/mapcanvas.js?v=4" type="text/javascript"></script>
            <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/player.js?v=4" type="text/javascript"></script>
            <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/shared.js?v=4" type="text/javascript"></script>
            <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/warsocial.js?v=4" type="text/javascript"></script>
        <% end %>

        <script src="/assets/gameboard/turn_timer.js?v=2" type="text/javascript"></script>
        <script src="/assets/gameboard/seats.js?v=2" type="text/javascript"></script>
        <script src="/assets/gameboard/lobby.js?v=2" type="text/javascript"></script>
        <script src="/assets/gameboard/create_game.js?v=2" type="text/javascript"></script>
    <% end %>

	<script type="text/javascript">
	
	var global_game_name;
	var global_init_data;

    $(document).ready(function() {
        global_game_name = "<%= @game.name %>";
        global_init_data = <%= @init_data.to_json.html_safe %>;
        lobby_maps = <%= @maps.to_json.html_safe %>;
        game = null;

        var addToChat = function(name, chat) {
            $('#main_discussion tbody').append($('<tr><td>' + name + ': ' + chat + '</td></tr>'));
            $("#chat_window").animate({ scrollTop: $("#chat_window").prop("scrollHeight") }, 300);
        };

        <% if !Rails.env.production? %>
        // Enable pusher logging - don't include this in production
        Pusher.log = function(message) {
            if (window.console && window.console.log) window.console.log(message);
        };

        // Flash fallback logging - don't include this in production
        WEB_SOCKET_DEBUG = true;
        <% end %>

        var pusher = new Pusher('<%= Pusher.key %>');
        var channel = pusher.subscribe("presence-<%= @game.name %>");
        Pusher.channel_auth_endpoint = '<%= auth_pusher_index_path %>';

        channel.bind('pusher:subscription_error', function(status) {
            if(status == 408 || status == 503){
                // retry?
            }
        });

        channel.bind('pusher:subscription_succeeded', function(members) {
            var memArray = [];
            members.each(function(member) {
                if (member.id != "anon") {
                    memArray.push(member.info.name);
                }
            });
            addToChat("Room", "Welcome to " + global_game_name + ". Players here: " + memArray.join(", ") + ".");
        });

        channel.bind('pusher:member_added', function(member) {
            if (member.id != "anon") {
                addToChat("Room", member.info.name + " is here.");
            }
        });

        channel.bind('pusher:member_removed', function(member) {
            if (member.id != "anon") {
                addToChat("Room", member.info.name + " has left.")
            }
        });

        $('#end_turn').hide();

        var seats = new Seats(7, global_init_data.players);
        seats.update_player_data(global_init_data.players);

        var lobby_modal = new Lobby("game_lobby");
        var create_game_modal = new CreateGame("create_game", lobby_maps);

        var who_am_i = <%= current_user != nil ? current_user.id : 0 %>;
        var who_am_i_name = "<%= current_user != nil ? current_user.username : "anon" %>";

        for(var i=0; i<global_init_data.players.length; i++) {
            if (global_init_data.players[i].is_turn == true) {
                seats.turn_start(global_init_data.players[i]);
                if (global_init_data.players[i].player_id == who_am_i) {
                    $('#end_turn').show();
                }
            }
        }

        channel.bind('new_chat_line', function(data) {
            if (data.name != who_am_i_name) {
                addToChat(data.name, data.entry);
            }
        });

        channel.bind('game_start', function(data) {
            data.who_am_i = who_am_i;

            $('#end_turn').hide();
            for(var i=0; i<data.players.length; i++) {
                var p = data.players[i];

                if (p.is_turn == true) {
                    seats.turn_start(p);
                    if (p.player_id == who_am_i) {
                        $('#end_turn').show();
                    }

                    addToChat("Room", "Game has started.");
                    addToChat("Room", p.name + "'s turn to move.");
                }
            }

            init(data);

            SoundManager.play("game_start");

            seats.update_player_data(data.players);
        });

        channel.bind('player_sit', function(player) {
            seats.sit(player);
        });

        channel.bind('player_stand', function(player) {
            seats.stand(player);
        });

        channel.bind('player_quit', function(player) {
            seats.update_player_data([player]);
            player_quit(player.player_id);
        });

        channel.bind('attack', function(data) {
            seats.turn_timer_restart({player_id: data.attack_info.attacker_player_id});
            seats.update_player_data(data.players);
            attack(data);
        });

        channel.bind('deploy', function(data) {
            deploy(data);
        });

        channel.bind('game_winner', function(player) {
            seats.clear();
            $('#end_turn').hide();

            addToChat("Room", player.name + " wins!");
        });

        channel.bind('new_turn', function(data) {
            if (data.current_player.player_id == who_am_i) {
                $('#end_turn').show();
                SoundManager.play("my_turn");
            } else {
                $('#end_turn').hide();
            }

            next_turn(data.current_player.player_id);
            seats.turn_start({ player_id: data.current_player.player_id});
            seats.update_player_data([data.previous_player, data.current_player]);

            addToChat("Room", data.current_player.name + "'s turn to move.");
        });

        $("#form_chat")
                .bind("ajax:beforeSend", function(xhr, settings) {
                    addToChat(who_am_i_name, $('#entry').val());
                    $('#entry').val("");
                });

        $('#stats').change(function() {
            var checked = $('#stats').prop('checked');
            if (checked) {
                $('.stats_enabled').show();
            } else {
                $('.stats_enabled').hide();
            }
        });
        $('#stats').change();

        $('#sit_button').bind('ajax:complete', function(evt, xhr, status) {
            switch(xhr.responseText) {
                case "not_logged_in":
                    addToChat("Room", "You are not currently logged in.  Please re-login.");
                    break;
                case "not_enough_points":
                    addToChat("Room", "You do not have enough points to sit at this table.");
                    break;
                case "already_in_game":
                    addToChat("Room", "You are already seated in this game.");
                    break;
            }
        });
    });

    $(window).load(function() {
        init(global_init_data);
    });
	
  </script>
<% end %>

<div id="game">
    <div style="margin-bottom: 5px; font-size:.98em;">This is our alpha release, so expect some bugs. If you can't play, try refreshing. Please report bugs in the <%= link_to "forum", "/forums/forums/1", :target => "_blank", :style => "color: blue" %>.</div>
    <div id="game_header">
      <div class="header_item" style="width:132px;">
        <h3 style="text-align: center; margin-top: 4px;"><%= @game.name %></h3>
      </div>
      <div class="header_item" style="width: 97px;">
        <h4 style="text-align: center; margin-top: 8px;"><%= "#{@game.wager_level} wager" %></h4>
      </div>
      <div class="header_item" style="width: 64px;">
        <h4 style="text-align: center; margin-top: 8px;"><%= "#{@game.max_player_count} seats" %></h4>
      </div>
      <div class="header_item" style="width:482px;">

      </div>
    </div>
    <div id="game_main">
      <% if user_signed_in? %>
          <%= link_to "Create Game", "#", "data-toggle" => "modal", :href => "#create_game", :class => "btn", :style => "margin-left: 10px;" %>
          <%= link_to "Lobby", "#", "data-toggle" => "modal", :href => "#game_lobby", :class => "btn" %>
          <%= link_to "Sit", sit_home_index_path(:game_name => @game.name), :remote => true, :id => "sit_button", :class => "btn" %>
          <%= link_to "Stand", stand_home_index_path(:game_name => @game.name), :remote => true, :class => "btn" %>
          <%= link_to "Flag", flag_home_index_path(:game_name => @game.name), :remote => true, :class => "btn btn-danger", :confirm => "Are you sure you want to surrender the battle?" %>
          <%= link_to "End Turn", end_turn_home_index_path(:game_name => @game.name), :remote => true, :id => "end_turn", :class => "btn btn-success", :style => "display: none;" %>
          <% if current_user.admin? %>
              <%= link_to "Kill Table", kill_table_home_index_path(:game_name => @game.name), :confirm => "Kill Table #{@game.name}: Are you sure?", :style => "float: right; margin-right: 10px;", :class => "btn" %>
          <% end %>
      <% else %>
          <%= link_to "Lobby", "#", "data-toggle" => "modal", :href => "#game_lobby", :class => "btn", :style => "margin-left: 10px;" %>
      <% end %>

      <div style="margin-top: 10px;">
            <div id="top_players">
                <div class="player">
                    <div id="game_seat_2" style="display: none;">
                        <div class="player_stat1">
                            <div class="avatar" style="background-color: #c22b2b"></div>
                            <div class="name"></div>
                            <div class="turn_progress" style="display:none"></div>
                        </div>
                        <div class="player_stat2">
                          <div class="place"></div>
                          <div class="points"></div>
                          <div class="dice stats_enabled"></div>
                          <div class="lands stats_enabled"></div>
                        </div>
                    </div>
                </div>
                <div class="player">
                    <div id="game_seat_3" style="display: none;">
                        <div class="player_stat1">
                            <div class="avatar" style="background-color: #5fb61f"></div>
                            <div class="name"></div>
                            <div class="turn_progress" style="display:none"></div>
                        </div>
                        <div class="player_stat2">
                          <div class="place"></div>
                          <div class="points"></div>
                          <div class="dice stats_enabled"></div>
                          <div class="lands stats_enabled"></div>
                        </div>
                    </div>
                </div>
                <div class="player">
                    <div id="game_seat_4" style="display: none;">
                        <div class="player_stat1">
                            <div class="avatar" style="background-color: #603bb3"></div>
                            <div class="name"></div>
                            <div class="turn_progress" style="display:none"></div>
                        </div>
                        <div class="player_stat2">
                          <div class="place"></div>
                          <div class="points"></div>
                          <div class="dice stats_enabled"></div>
                          <div class="lands stats_enabled"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="position: relative">
                <div id="left_players">
                    <div class="player">
                        <div id="game_seat_1" class="ws_bordered" style="display: none;">
                            <div class="player_stat1">
                                <div class="avatar" style="background-color: #3760ae"></div>
                                <div class="clear"></div>
                                <div class="name"></div>
                                <div class="turn_progress" style="display:none"></div>
                            </div>
                            <div class="player_stat2">
                              <div class="place"></div>
                              <div class="points"></div>
                              <div class="dice stats_enabled"></div>
                              <div class="lands stats_enabled"></div>
                            </div>
                        </div>
                    </div>
                    <div class="player">
                        <div id="game_seat_0" class="ws_bordered" style="display: none;">
                            <div class="player_stat1">
                                <div class="avatar" style="background-color: #f8af01"></div>
                                <div class="clear"></div>
                                <div class="name"></div>
                                <div class="turn_progress" style="display:none"></div>
                            </div>
                            <div class="player_stat2">
                              <div class="place"></div>
                              <div class="points"></div>
                              <div class="dice stats_enabled"></div>
                              <div class="lands stats_enabled"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="stage" style="top: 0px; left: 0px; position:relative; padding:0; margin:0 auto 0 auto; width:600px; height:420px;">
                    <canvas id="canvas_shadow" width="600" height="420" style="z-index:0; position:absolute; left:0px; top:0px;">Your browser does not support the canvas element.</canvas>
                    <canvas id="canvas_map" width="600" height="420" style="z-index:1; position:absolute; left:0px; top:0px;"></canvas>
                    <canvas id="canvas_hilight_origin" width="600" height="420" style="z-index:2; position:absolute; left:0px; top:0px;"></canvas>

                    <canvas id="canvas_hilight_destination" width="600" height="420" style="z-index:2; position:absolute; left:0px; top:0px;"></canvas>
                    <canvas id="canvas_dice" width="600" height="420" style="z-index:3; position:absolute; left:0px; top:0px;"></canvas>
                    <div id="dice_container" style="z-index:3; position:absolute; left:0px; top:0px; width:600px; height:420px;"></div>
                    <canvas id="canvas_dice_box" width="600" height="420" style="z-index:4; position:absolute; left:0px; top:0px;"></canvas>
                    <div id="dice_box_text_attacker" style="z-index:5; position:absolute; left:0px; top:0px;"></div>
                    <div id="dice_box_text_defender" style="z-index:5; position:absolute; left:0px; top:0px;"></div>
                    <%= image_tag("gameboard/texture.png", :id => 'pattern', :style => 'display:none') %>
                    <%= image_tag("gameboard/dice1.png", :id => 'dice1', :style => 'display:none') %>
                    <%= image_tag("gameboard/dice2.png", :id => 'dice2', :style => 'display:none') %>
                    <%= image_tag("gameboard/dice3.png", :id => 'dice3', :style => 'display:none') %>
                    <%= image_tag("gameboard/dice4.png", :id => 'dice4', :style => 'display:none') %>
                    <%= image_tag("gameboard/dice5.png", :id => 'dice5', :style => 'display:none') %>
                    <%= image_tag("gameboard/dice6.png", :id => 'dice6', :style => 'display:none') %>
                    <%= image_tag("gameboard/dice_shadow.png", :id => 'dice_shadow', :style => 'display:none') %>
                </div>
                <div id="right_players">
                    <div class="player">
                        <div id="game_seat_5" class="ws_bordered" style="display: none;">
                            <div class="player_stat1">
                                <div class="avatar" style="background-color: #27a7b2"></div>
                                <div class="clear"></div>
                                <div class="name"></div>
                                <div class="turn_progress" style="display:none"></div>
                            </div>
                            <div class="player_stat2">
                              <div class="place"></div>
                              <div class="points"></div>
                              <div class="dice stats_enabled"></div>
                              <div class="lands stats_enabled"></div>
                            </div>
                        </div>
                    </div>
                    <div class="player">
                        <div id="game_seat_6" class="ws_bordered" style="display: none;">
                            <div class="player_stat1">
                                <div class="avatar" style="background-color: #ad3bac"></div>
                                <div class="clear"></div>
                                <div class="name"></div>
                                <div class="turn_progress" style="display:none"></div>
                            </div>
                            <div class="player_stat2">
                              <div class="place"></div>
                              <div class="points"></div>
                              <div class="dice stats_enabled"></div>
                              <div class="lands stats_enabled"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      <div style="margin-bottom:5px;">
        <input id="stats" type="checkbox" checked="checked" style="margin-left: 10px;" /> <span>stats</span>
      </div>
    </div>

    <div id="chat_window">
        <table id="main_discussion" style="margin-left: 5px;">
            <tbody>
            </tbody>
        </table>
    </div>
</div>

<% if user_signed_in? %>
    <div style="text-align: center;">
    <%= form_tag(add_line_home_index_path, :id => "form_chat", :remote=>true, :autocomplete => "off") do %>
        <%= hidden_field_tag 'game_name', @game.name %>
        <%= text_field_tag 'entry', nil, { :size => 70, :id => 'entry', :class => "input"} %>
        <%= submit_tag "Send", { :class => "common_button", :disable_with => "Sending..." }
         %>
    <% end %>
    </div>
<% end %>

<%= render "shared/game_lobby" %>
<%= render "shared/create_game" %>
