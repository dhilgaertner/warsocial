<% content_for :javascript_includes do %>
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache, must-revalidate, max-age=0, no-store" />

    <link rel="stylesheet" type="text/css" href="/css/jquery-ui-1.8.18.custom.css">

    <script src="http://js.pusher.com/1.12/pusher.min.js" type="text/javascript"></script>

    <% if Rails.env.development? || @dev || @dev_image %>
        <script src="/assets/lib/jquery.dataTables.min.js?v=2" type="text/javascript"></script>
        <script src="/assets/lib/customSelect.jquery.js" type="text/javascript"></script>

        <% if !@dev && !@dev_image %>
            <script src="/assets/gameboard/communications.js?v=2" type="text/javascript"></script>
            <script src="/assets/gameboard/soundmanager.js?v=2" type="text/javascript"></script>
            <script src="/assets/gameboard/dicebox.js?v=2" type="text/javascript"></script>
            <script src="/assets/gameboard/land.js?v=2" type="text/javascript"></script>
            <script src="/assets/gameboard/map.js?v=2" type="text/javascript"></script>
            <script src="/assets/gameboard/mapcanvas.js?v=2" type="text/javascript"></script>
            <script src="/assets/gameboard/player.js?v=2" type="text/javascript"></script>
            <script src="/assets/gameboard/shared.js?v=2" type="text/javascript"></script>
            <script src="/assets/gameboard/warsocial.js?v=2" type="text/javascript"></script>
        <% else %>
            <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/communications.js?v=4" type="text/javascript"></script>
            <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/soundmanager.js?v=4" type="text/javascript"></script>
            <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/dicebox.js?v=4" type="text/javascript"></script>
            <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/land.js?v=4" type="text/javascript"></script>
            <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/map.js?v=4" type="text/javascript"></script>
            <% if @dev %>
                <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/mapcanvas.js?v=4" type="text/javascript"></script>
            <% else %>
                <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/mapcanvas_sprite.js?v=4" type="text/javascript"></script>
            <% end %>
            <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/player.js?v=4" type="text/javascript"></script>
            <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/shared.js?v=4" type="text/javascript"></script>
            <script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/warsocial.js?v=4" type="text/javascript"></script>
        <% end %>

        <script src="/assets/gameboard/turn_timer.js?v=2" type="text/javascript"></script>
        <script src="/assets/gameboard/seats.js?v=2" type="text/javascript"></script>
        <script src="/assets/gameboard/lobby.js?v=2" type="text/javascript"></script>
        <script src="/assets/gameboard/chatbox.js?v=2" type="text/javascript"></script>
        <script src="/assets/gameboard/gamelog.js?v=2" type="text/javascript"></script>
        <script src="/assets/gameboard/create_game.js?v=2" type="text/javascript"></script>
    <% end %>

    <script type="text/javascript">

        var global_game_name;
        var global_init_data;

        $(document).ready(function() {
            global_game_name = "<%= @game.name %>";
            global_init_data = <%= @init_data.to_json.html_safe %>;
            lobby_maps = <%= @maps.to_json.html_safe %>;
            game = null;

            var seats = new Seats(7, global_init_data.players);
            seats.update_player_data(global_init_data.players);

            var chatbox = new ChatBox("chat_window", seats);
            var gamelog = new GameLog("log_window", seats);

            <% if !Rails.env.production? %>
            // Enable pusher logging - don't include this in production
            Pusher.log = function(message) {
                if (window.console && window.console.log) window.console.log(message);
            };

            // Flash fallback logging - don't include this in production
            WEB_SOCKET_DEBUG = true;
            <% end %>

            var pusher = new Pusher('<%= Pusher.key %>');
            var channel = pusher.subscribe("presence-<%= @game.name %>");
            Pusher.channel_auth_endpoint = '<%= auth_pusher_index_path %>';

            channel.bind('pusher:subscription_error', function(status) {
                if(status == 408 || status == 503){
                    if (window.console && window.console.log) window.console.log("Error establishing connection: " + status.toString());
                }
            });

            channel.bind('pusher:subscription_succeeded', function(members) {
                var memArray = [];
                members.each(function(member) {
                    if (member.id != "anon") {
                        memArray.push(member.info.name);
                    }
                });
                chatbox.addChatLine("Room", "Welcome to " + global_game_name + ". Players here: " + memArray.join(", ") + ".");
            });

            channel.bind('pusher:member_added', function(member) {
                if (member.id != "anon") {
                    chatbox.addChatLine("Room", member.info.name + " is here.");
                }
            });

            channel.bind('pusher:member_removed', function(member) {
                if (member.id != "anon") {
                    chatbox.addChatLine("Room", member.info.name + " has left.")
                }
            });

            $('#end_turn').hide();

            var lobby_modal = new Lobby("game_lobby");
            var create_game_modal = new CreateGame("create_game", lobby_maps);

            var who_am_i = <%= current_user != nil ? current_user.id : 0 %>;
            var who_am_i_name = "<%= current_user != nil ? current_user.username : "anon" %>";

            for(var i=0; i<global_init_data.players.length; i++) {
                if (global_init_data.players[i].is_turn == true) {
                    seats.turn_start(global_init_data.players[i]);
                    if (global_init_data.players[i].player_id == who_am_i) {
                        $('#end_turn').show();
                    }
                }
            }

            channel.bind('new_chat_line', function(data) {
                if (data.name != who_am_i_name) {
                    chatbox.addChatLine(data.name, data.entry);
                }
            });

            channel.bind('game_start', function(data) {
                data.who_am_i = who_am_i;

                $('#end_turn').hide();
                for(var i=0; i<data.players.length; i++) {
                    var p = data.players[i];

                    if (p.is_turn == true) {
                        seats.turn_start(p);
                        if (p.player_id == who_am_i) {
                            $('#end_turn').show();
                        }

                        gamelog.logGameStarted();
                        gamelog.logTurnChange(p.name);
                    }
                }

                init(data);

                SoundManager.play("game_start");

                seats.update_player_data(data.players);
            });

            channel.bind('player_sit', function(player) {
                seats.sit(player);
            });

            channel.bind('player_stand', function(player) {
                seats.stand(player);
            });

            channel.bind('player_quit', function(player) {
                seats.update_player_data([player]);
                player_quit(player.player_id);
            });

            channel.bind('attack', function(data) {
                seats.turn_timer_restart({player_id: data.attack_info.attacker_player_id});
                seats.update_player_data(data.players);
                attack(data);
                gamelog.logAttack(data);
            });

            channel.bind('deploy', function(data) {
                deploy(data);
            });

            channel.bind('game_winner', function(player) {
                seats.clear();
                $('#end_turn').hide();

                gamelog.logGameWinner(player.name);
            });

            channel.bind('new_turn', function(data) {
                if (data.current_player.player_id == who_am_i) {
                    $('#end_turn').show();
                    SoundManager.play("my_turn");
                } else {
                    $('#end_turn').hide();
                }

                next_turn(data.current_player.player_id);
                seats.turn_start({ player_id: data.current_player.player_id});
                seats.update_player_data([data.previous_player, data.current_player]);

                gamelog.logTurnChange(data.current_player.name);
            });

            $("#form_chat")
                    .bind("ajax:beforeSend", function(xhr, settings) {
                        chatbox.addChatLine(who_am_i_name, $('#entry').val());
                        $('#entry').val("");
                    });

            $('#stats').change(function() {
                var checked = $('#stats').prop('checked');
                if (checked) {
                    $('.stats_enabled').show();
                } else {
                    $('.stats_enabled').hide();
                }

                $.post("<%= settings_toggle_stats_url %>", { on: checked });
            });
            $('#stats').change();

            $('#dice_visible').change(function() {
                var checked = $('#dice_visible').prop('checked');
                dice_visible(checked);
            });
            $('#dice_visible').change();

            $('#sounds').change(function() {
                var checked = $('#sounds').prop('checked');
                sounds_toggle(checked);

                $.post("<%= settings_toggle_sounds_url %>", { on: checked });
            });
            $('#dice_visible').change();

            $('#sit_button').bind('ajax:complete', function(evt, xhr, status) {
                switch(xhr.responseText) {
                    case "not_logged_in":
                        addToChat("Room", "You are not currently logged in.  Please re-login.");
                        break;
                    case "not_enough_points":
                        addToChat("Room", "You do not have enough points to sit at this table.");
                        break;
                    case "already_in_game":
                        addToChat("Room", "You are already seated in this game.");
                        break;
                }
            });
        });

        $(window).load(function() {
            init(global_init_data);
        });

    </script>
<% end %>

<div id="game">
<div style="margin-bottom: 5px; font-size:.98em;">This is our alpha release, so expect some bugs. If you can't play, try refreshing. Please report bugs in the <%= link_to "forum", "/forums/forums/1", :target => "_blank", :style => "color: blue" %>.</div>
<div id="game_header">
  <div class="header_item" style="width:132px;">
    <h3 style="text-align: center; margin-top: 4px;"><%= @game.name %></h3>
  </div>
  <div class="header_item" style="width: 97px;">
    <h4 style="text-align: center; margin-top: 8px;"><%= "#{@game.wager_level} wager" %></h4>
  </div>
  <div class="header_item" style="width: 64px;">
    <h4 style="text-align: center; margin-top: 8px;"><%= "#{@game.max_player_count} seats" %></h4>
  </div>
  <div class="header_item" style="width:482px;">

  </div>
</div>

<%= render "shared/game_board" %>

<div id="log_window">
  <table style="width: 100%">
    <tbody>
    </tbody>
  </table>
</div>
<div id="chat_window">
  <table style="margin-left: 5px; margin-right: 5px;">
    <tbody>
    </tbody>
  </table>
</div>
</div>

<% if user_signed_in? %>
    <div style="text-align: center;">
      <%= form_tag(add_line_home_index_path, :id => "form_chat", :remote => true, :autocomplete => "off") do %>
          <%= hidden_field_tag 'game_name', @game.name %>
          <%= text_field_tag 'entry', nil, { :size => 70, :id => 'entry', :class => "input"} %>
          <%= submit_tag "Send", { :class => "common_button", :disable_with => "Sending...", :onClick => "_gaq.push(['_trackEvent', 'Buttons', 'Chat Submit']);" } %>
      <% end %>
    </div>
<% end %>

<%= render "shared/game_lobby" %>
<%= render "shared/create_game" %>
