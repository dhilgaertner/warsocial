<% content_for :javascript_includes do %>

	<script src="http://js.pusherapp.com/1.9/pusher.min.js" type="text/javascript"></script>
	
	<% if @dev %>
		<script src="../../../Gameboard/communications.js" type="text/javascript"></script>
		<script src="../../../Gameboard/land.js" type="text/javascript"></script>
		<script src="../../../Gameboard/map.js" type="text/javascript"></script>
		<script src="../../../Gameboard/mapcanvas.js" type="text/javascript"></script>
		<script src="../../../Gameboard/player.js" type="text/javascript"></script>
		<script src="../../../Gameboard/shared.js" type="text/javascript"></script>
		<script src="../../../Gameboard/warsocial.js" type="text/javascript"></script>
	<% else %>
		<script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/communications.js" type="text/javascript"></script>
		<script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/land.js" type="text/javascript"></script>
		<script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/map.js" type="text/javascript"></script>
		<script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/mapcanvas.js" type="text/javascript"></script>
		<script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/player.js" type="text/javascript"></script>
		<script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/shared.js" type="text/javascript"></script>
		<script src="http://www.bigroundeyes.ca/clients/Dustin/warsocial/warsocial/warsocial.js" type="text/javascript"></script>
	<% end %>
	
	<script type="text/javascript">
	
	var global_game_name;
	
	$(document).ready(function() {
	  	// Enable pusher logging - don't include this in production
	    Pusher.log = function(message) {
	      if (window.console && window.console.log) window.console.log(message);
	    };
			
	    // Flash fallback logging - don't include this in production
	    WEB_SOCKET_DEBUG = true;
			var pusher = new Pusher('f85901afd3e9eaff226f');
	    var channel = pusher.subscribe("<%= @game.name %>");
	    channel.bind('new_chat_line', function(data) {
		  	$('#chat_list').append($('<li>' + data.name + ': ' + data.entry + '</li>'));
	    });
			
			$('#end_turn').hide();
			
			var who_am_i = <%= current_user != nil ? current_user.id : 0 %>;
			
			channel.bind('game_start', function(data) {
				data.who_am_i = who_am_i;
				
				$('#end_turn').hide();
				for(var i=0; i<data.players.length; i++) {
		    	if (data.players[i].is_turn == true) {
						if (data.players[i].player_id == who_am_i) {
							$('#end_turn').show();
						}
					}
		    }
				
				data.players
		  	init(data);
	    });
			
			channel.bind('attack', function(data) {
		  	attack(data);
	    });
	
			channel.bind('new_turn', function(data) {
				if (data.player_id == who_am_i) {
					$('#end_turn').show();
				} else {
					$('#end_turn').hide();
				}
		  	next_turn(data.player_id);
	    });
			
			global_game_name = "<%= @game.name %>";
			game = null;
			
			init(<%= @init_data.to_json.html_safe %>);
			
	});
  </script>
<% end %>

<% if user_signed_in? %>

	<%= link_to "Sit", add_line_home_index_path(:game_name => @game.name, :entry => "sit"), :remote=>true, :id => "sit_in" %>
	
	<div id="stage" style="position:relative; padding:0; margin:0 auto 0 auto; width:600px; height:420px;">
		<canvas id="canvas_shadow" width="600" height="420" style="z-index:0; position:absolute; left:0px; top:0px;">Your browser does not support the canvas element.</canvas>
		<canvas id="canvas_map" width="600" height="420" style="z-index:1; position:absolute; left:0px; top:0px;"></canvas>
		<canvas id="canvas_hilight_origin" width="600" height="420" style="z-index:2; position:absolute; left:0px; top:0px;"></canvas>
		<canvas id="canvas_hilight_destination" width="600" height="420" style="z-index:2; position:absolute; left:0px; top:0px;"></canvas>
	  <canvas id="canvas_dice" width="600" height="420" style="z-index:3; position:absolute; left:0px; top:0px;"></canvas>
	  <canvas id="canvas_dice_box" width="600" height="420" style="z-index:4; position:absolute; left:0px; top:0px;"></canvas>
		<%= image_tag("gameboard/texture.png", :id => 'pattern', :style => 'display:none') %>
		<%= image_tag("gameboard/dice1.png", :id => 'dice1', :style => 'display:none') %>
		<%= image_tag("gameboard/dice2.png", :id => 'dice2', :style => 'display:none') %>
		<%= image_tag("gameboard/dice3.png", :id => 'dice3', :style => 'display:none') %>
		<%= image_tag("gameboard/dice4.png", :id => 'dice4', :style => 'display:none') %>
		<%= image_tag("gameboard/dice5.png", :id => 'dice5', :style => 'display:none') %>
		<%= image_tag("gameboard/dice6.png", :id => 'dice6', :style => 'display:none') %>
		<%= image_tag("gameboard/dice_shadow.png", :id => 'dice_shadow', :style => 'display:none') %>
	</div>
	<%= link_to "End Turn", end_turn_home_index_path(:game_name => @game.name), :remote=>true, :id => "end_turn" %>
	<div id="chat_window" class="bordered">
  		<ul id="chat_list">
  		</ul>
	</div>
	
	<center>
	<%= form_tag(add_line_home_index_path, :method=>'get', :remote=>true) do %>
		<%= hidden_field_tag 'game_name', @game.name %>
		<%= text_field_tag 'entry', nil, { :size => 70, :id => 'entry', :class => "input"} %>
		<%= submit_tag "Send", { :class => "common_button" } %>
	<% end %>
	</center>
<% else %>
  	<%= form_for @user, :url => user_session_path do |f| %>
  	<div><%= f.label :email %><br />
  	<%= f.email_field :email %></div>
  	<div><%= f.label :password %><br />
  	<%= f.password_field :password %></div>
  	<div><%= f.check_box :remember_me %> <%= f.label :remember_me %></div>
  	<div><%= f.submit "Sign in" %></div>
  	<% end %>
  	<%= link_to "Sign in with Facebook", user_omniauth_authorize_path(:facebook) %> </br>
<% end %>
