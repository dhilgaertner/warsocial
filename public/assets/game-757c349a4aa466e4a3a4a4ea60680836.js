function ChatBox(a,b){this._chatwindow=$("#"+a),this._tbody=this._chatwindow.find("table tbody"),this._seats=b,this.setupChatBox()}function init(a){if(game!=null||game!=undefined)game.reset(),game=null;game=new WarSocial,game!=undefined&&game!=null&&game.init(a)}function attack(a){try{game!=undefined&&game!=null&&game.attack(a)}catch(b){alert(b+" json = "+json)}}function deploy(a){game!=undefined&&game!=null&&game.deploy(a)}function next_turn(a){game!=undefined&&game!=null&&game.nextTurn(parseInt(a))}function player_quit(a){game!=undefined&&game!=null&&game.playerQuit(a)}function dice_visible(a){game!=undefined&&game!=null&&game.toggle_dice(a)}function sounds_toggle(a){game!=undefined&&game!=null&&game.toggle_sounds(a)}function attack_out(a,b){$.ajax({type:"POST",url:"/game/"+global_game_name+"/attack",data:{atk_land_id:a,def_land_id:b},success:function(a){},dataType:"text"})}function DiceBox(){var a=["#CCCCCC","#f8af01","#3760ae","#c22b2b","#5fb61f","#603bb3","#27a7b2","#ad3bac","#814f2e"],b=["#CCCCCC","#ffcc00","#296dff","#ed1a1a","#86ce28","#7743ec","#2bb9dd","#ca43ec","#a26136"],c=["#CCCCCC","#e0c148","#9dbcff","#ff8c8c","#9cd552","#ad89ff","#63c8e2","#db8eef","#c78458"],d=280,e=330,f=75,g=8,h=38,i=18,j=20,k=30,l=8,m=8,n=31,o=100,p="#dice_box_text_attacker",q="#dice_box_text_defender",r,s=10,t,u,v=new Array,w=new Array,x=0,y,z,A=0,B=0,C=document.getElementById("canvas_dice_box"),D=C.getContext("2d");this.getPlayerColourStroke=function(){return b},this.getPlayerColourFill=function(){return a},this.getPlayerColourText=function(){return c},this.getRollIndex=function(){return x},this.getDiceTimer=function(){return t},this.setDiceTimer=function(){t!=undefined&&clearInterval(t);var a=this;t=setInterval(function(){a.dice_box_display_dice()},s)},this.clear_dicetimer=function(){t!=undefined&&clearInterval(t)},this.getAttackerSum=function(){return A},this.getDefenderSum=function(){return B},this.setAttackerSum=function(a){A=a},this.setDefenderSum=function(a){B=a};var E={margin:"0",padding:"0","font-family":"arial","font-size":"24px","font-weight":"bold"};$(p).css(E),$(q).css(E),this.hexToR=function(a){return parseInt(this.cutHex(a).substring(0,2),16)},this.hexToG=function(a){return parseInt(this.cutHex(a).substring(2,4),16)},this.hexToB=function(a){return parseInt(this.cutHex(a).substring(4,6),16)},this.cutHex=function(a){return a.charAt(0)=="#"?a.substring(1,7):a},this.show_dice_box=function(a,b,c,i){this.clear_dice_box(),clearTimeout(u),this.clear_dicetimer(),x=0,v=a,w=b,y=c,z=i;var k=0,o=0,s=0,t=this;v.length>w.length?r=h+j*(v.length+1):r=h+j*(w.length+1),k=d-r/2,o=e,this.draw_dice_box(k,o,r,f,g,D),$(p).html("0"),$(q).html("0"),$(p).css({top:o+m,left:k+l}),$(q).css({top:o+m+n,left:k+l}),$(p).css("color",this.getPlayerColourText()[y]),$(q).css("color",this.getPlayerColourText()[z]),$(p).css({opacity:1}),$(q).css({opacity:1}),this.setDiceTimer(),$("#canvas_dice_box").css({opacity:1}),u=setTimeout(function(){t.hide_dice_box(t)},2e3)},this.draw_dice_box=function(a,b,c,d,e,f){f.beginPath(),f.moveTo(a+e,b),f.lineTo(a+c-e,b),f.quadraticCurveTo(a+c,b,a+c,b+e),f.lineTo(a+c,b+d-e),f.quadraticCurveTo(a+c,b+d,a+c-e,b+d),f.lineTo(a+e,b+d),f.quadraticCurveTo(a,b+d,a,b+d-e),f.lineTo(a,b+e),f.quadraticCurveTo(a,b,a+e,b),f.closePath(),f.shadowBlur=10,f.shadowColor="rgba(0, 0, 0, 0.5)",f.fillStyle="rgba(0, 0 ,0, 1.0)",f.fill(),f.globalCompositeOperation="xor",f.shadowBlur=0,f.fill(),f.globalCompositeOperation="source-over",f.strokeStyle="rgba(0, 0, 0, 0.15)",f.lineWidth=4,f.stroke(),f.strokeStyle="rgba(255, 255, 255, 0.75)",f.lineWidth=2,f.stroke();var g=f.createLinearGradient(a,b,a,b+d);g.addColorStop(1,"rgba(50, 50, 50, 0.95)"),g.addColorStop(0,"rgba(100, 100, 100, 0.95)"),f.fillStyle=g,f.fill()},this.dice_box_display_dice=function(){var a=this.getRollIndex(),b=0;if(a<v.length||a<w.length){var c=d-r/2,f=e;v.length>a&&(this.draw_dice(c+h+j*a,f+i,v[a],!0,D,y),b=this.getAttackerSum(),b+=v[a],this.setAttackerSum(b),$(p).html(b)),w.length>a&&(this.draw_dice(c+h+j*a,f+i+k,w[a],!0,D,z),b=this.getDefenderSum(),b+=w[a],this.setDefenderSum(b),$(q).html(b)),x++}else this.getAttackerSum()>this.getDefenderSum()?$(q).css({opacity:.5}):$(p).css({opacity:.5}),this.clear_dicetimer(),w=new Array,v=new Array,this.setAttackerSum(0),this.setDefenderSum(0),x=0},this.hide_dice_box=function(a){$("#canvas_dice_box").css({opacity:0}),$(p).html(""),$(q).html("")},this.clear_dice_box=function(){var a=document.getElementById("canvas_dice_box"),b=a.getContext("2d");b.clearRect(0,0,a.width,a.height)},this.draw_dice=function(a,b,c,d,e,f){var g="dice",h="dice_shadow",i=4,j=-6,k=20,l=20,m=i-2,n=j+4,o=$("#"+(g+c))[0];if(d){var p=$("#"+h)[0];e.drawImage(p,a+m,b+n)}var q=$("#canvas_dice")[0],r=10,s=q.getContext("2d"),t=this.getPlayerColourFill()[f],u=.4,v="rgba("+this.hexToR(t)+","+this.hexToG(t)+","+this.hexToB(t)+","+u+")";q.width=k+r*2,q.height=l+r*2,s.fillStyle=v,s.drawImage(o,i+r,j+r),s.globalCompositeOperation="lighter",s.fillRect(i+r,j+r,k,l),s.globalCompositeOperation="destination-in",s.drawImage(o,i+r,j+r),e.drawImage(q,a-r,b-r),s.clearRect(0,0,q.width,q.height)}}function game_page_init(a,b,c,d,e,f,g,h,i){global_game_name=a,global_init_data=c,lobby_maps=d,game=null;var j=!1;for(var k=0;k<global_init_data.players.length;k++)global_init_data.players[k].is_turn==1&&(j=!0);var l=b=="multi_day"?1e6:20,m=new Seats(h,7,global_init_data.players,j,l);m.update_player_data(global_init_data.players);var n=new ChatBox("chat-window",m),o=new GameLog("log-window",m);e||(Pusher.log=function(a){window.console&&window.console.log&&window.console.log(a)},WEB_SOCKET_DEBUG=!0);var p=new Pusher(f),q=p.subscribe("presence-"+a);Pusher.channel_auth_endpoint=i.paurl,q.bind("pusher:subscription_error",function(a){(a==408||a==503)&&window.console&&window.console.log&&window.console.log("Error establishing connection: "+a.toString())}),q.bind("pusher:subscription_succeeded",function(a){var b=[];a.each(function(a){a.id!="anon"&&b.push(a.info.name)}),n.addChatLine("Room","Welcome to "+global_game_name+". Players here: "+b.join(", ")+".")}),q.bind("pusher:member_added",function(a){a.id!="anon"&&n.addChatLine("Room",a.info.name+" is here.")}),q.bind("pusher:member_removed",function(a){a.id!="anon"&&n.addChatLine("Room",a.info.name+" has left.")}),init(global_init_data);var r=new Lobby("game_lobby"),s=new CreateGame("create_game",lobby_maps),t=new Settings("settings"),u=g,v=h;for(var k=0;k<global_init_data.players.length;k++)global_init_data.players[k].is_turn==1&&m.turn_start(global_init_data.players[k]);q.bind("new_chat_line",function(a){a.name!=v&&n.addChatLine(a.name,a.entry)}),q.bind("server_message",function(a){n.addServerMessage(a)}),q.bind("game_start",function(a){a.who_am_i=u;for(var b=0;b<a.players.length;b++){var c=a.players[b];c.is_turn==1&&(m.turn_start(c),o.logGameStarted(),o.logTurnChange(c.name))}init(a),SoundManager.play("game_start"),m.game_started(),m.update_player_data(a.players)}),q.bind("player_sit",function(a){m.sit(a)}),q.bind("player_stand",function(a){m.stand(a)}),q.bind("player_quit",function(a){m.update_player_data([a]),player_quit(a.player_id)}),q.bind("attack",function(a){m.turn_timer_restart({player_id:a.attack_info.attacker_player_id}),m.update_player_data(a.players),attack(a),o.logAttack(a)}),q.bind("deploy",function(a){deploy(a)}),q.bind("game_winner",function(a){m.clear(),o.logGameWinner(a.name)}),q.bind("new_turn",function(a){a.current_player.player_id==u&&SoundManager.play("my_turn"),next_turn(a.current_player.player_id),m.turn_start({name:a.current_player.name,player_id:a.current_player.player_id}),m.update_player_data([a.previous_player,a.current_player]),o.logTurnChange(a.current_player.name)}),$("#entry").keyup(function(a){a.keyCode==13&&(n.addChatLine(v,$("#entry").val()),$("#entry").val(""),$("#form_chat").submit())}),$("#dice_visible").click(function(){var a=$(this).hasClass("active");a?($(this).find("i").removeClass("icon-eye-close"),$(this).find("i").addClass("icon-eye-open")):($(this).find("i").removeClass("icon-eye-open"),$(this).find("i").addClass("icon-eye-close")),typeof dice_visible!="undefined"&&dice_visible(a)}),$("#dice_visible").change();var w=function(){var a=$("#stats").prop("checked");a?$(".stats_enabled").show():$(".stats_enabled").hide()};w(),$("#stats").change(function(){w();var a=$("#stats").prop("checked");g!=0&&$.post(i.settings_toggle_stats_url,{on:a})});var x=$("#setting-sounds .active").val()=="true";typeof sounds_toggle!="undefined"&&sounds_toggle(x),$("div.label-over label").labelOver("over-apply"),$("#map-voting").hover(function(){$(this).find(".btn").show()},function(){$(this).find(".btn").hide()});var y=$("#game-map-info");y.find("a.vote").click(function(){var a=y.data("map-id"),b=$(this).data("vote");return b=="0"?(y.addClass("thumb-down"),y.removeClass("thumb-up")):(y.addClass("thumb-up"),y.removeClass("thumb-down")),$.ajax({type:"POST",url:"/maps/"+a+"/vote",data:{vote:b.toString()},dataType:"json"}),!1}),$(".action-sit a").bind("ajax:complete",function(a,b,c){switch(b.responseText){case"not_logged_in":n.addChatLine("Room","You are not currently logged in.  Please re-login.");break;case"not_enough_points":n.addChatLine("Room","You do not have enough points to sit at this table.  This includes amounts already wagered at other tables you are currently seated at..");break;case"already_in_game":n.addChatLine("Room","You are already seated in this game.")}})}function GameLog(a,b){this._logwindow=$("#"+a),this._tbody=this._logwindow.find("table tbody"),this._seats=b,this.setupGameLog()}function Land(a){var b=0;a!=undefined&&(b=a);var c=null,d=0,e=0,f=[];this.getId=function(){return b},this.getOwner=function(){return c},this.setOwner=function(a){if(a==null||a instanceof Player)c=a},this.getTroops=function(){return d},this.setTroops=function(a){a!=undefined&&a.constructor===Number&&(e=a-d,d=a)},this.getNewTroops=function(){var a=e<0?0:e;return e=0,a},this.getAdjacentLandIds=function(){return f},this.addAdjacentLandId=function(a){a!=undefined&&a.constructor===Number&&f.indexOf(a)==-1&&f.push(a)}}function Map(a,b,c){var d=a!=undefined&&a.constructor===Number?a:0,e=b!=undefined&&b.constructor===Number?b:0,f=c instanceof Array?c:[],g=[];this.getLandList=function(){return g},this.getWidth=function(){return d},this.getHeight=function(){return e},this.getTiles=function(){return f},d>0&&e>0&&(g=this.createLandList(c),g.length>0&&(f=c)),this.find_adjacent_lands_from_tiles(f,d,e);var h=new MapCanvas;this.getMapCanvas=function(){return h}}function MapCanvas(){var a=28,b=[4,16,20,16,4,0,4],c=[0,0,6,12,12,6,0],d=30,e=12,f=16,g=["#CCCCCC","#f8af01","#3760ae","#c22b2b","#5fb61f","#603bb3","#27a7b2","#ad3bac","#814f2e"],h=["#CCCCCC","#ffcc00","#296dff","#ed1a1a","#86ce28","#7743ec","#2bb9dd","#ca43ec","#a26136"],i=!0,j=100,k,l,m,n;this.getColWidth=function(){return f},this.getRowHeight=function(){return e},this.getCanvasMargin=function(){return d},this.getShapePointX=function(){return b},this.getShapePointY=function(){return c},this.getShapeWidth=function(){return a},this.getMapDiceTimer=function(){return k},this.setMapDiceTimer=function(){k!=undefined&&clearInterval(k);var a=this;k=setInterval(function(){a.show_new_die()},j)},this.getTopLayerCanvas=function(){return document.getElementById("canvas_dice")},this.setDelayedDiceArray=function(a){l=a},this.getDelayedDiceArray=function(){return l},this.setLandDicePositions=function(a){m=a},this.getLandDicePositions=function(){return m},this.setDiceCanvasList=function(a){n=a},this.getDiceCanvasList=function(){return n},this.get_first_display=function(){return i},this.set_first_display=function(a){i=a},this.getPlayerColourFill=function(){return g},this.getPlayerColourStroke=function(){return h}}function Player(a,b,c,d){var e=a==undefined?-1:a,f=b==undefined?!1:b,g=c==undefined?"CCCCCC":c,h=d==undefined?0:d;this.getId=function(){return e},this.isUser=function(){return f},this.getColor=function(){return g},this.getSeatId=function(){return h}}function Seats(a,b,c,d,e){var f=this;this._seats=new Object,this.is_game_started=d,this.who_am_i=a,this.timer=new TurnTimer($("#turn-timer-box"),e),$("#game-forfeit").hide(),$("#game-endturn").hide(),$("#turn-timer-box").hide(),$("#game-endturn").click(function(){if($(this).hasClass("disabled"))return!1});for(i=0;i<b;i++){var g=$("#game_seat_"+i.toString());this._seats[i.toString()]={player:null,seat:g}}this.occupySeat=function(b,c){function e(a){var b={url:null,name:null};return a>100?b:(a>25?(b.url=badges.top100,b.name="Top 100"):a>10?(b.url=badges.top25,b.name="Top 25"):a>3?(b.url=badges.top10,b.name="Top 10"):a==3?(b.url=badges.bronze,b.name="3rd"):a==2?(b.url=badges.silver,b.name="2nd"):a==1&&(b.url=badges.gold,b.name="1st"),b)}var d=f._seats[b];d.player=c,$(d.seat).find(".name").html("<a target='_blank' style='color: inherit;' href='/u/"+c.name+"'>"+c.name+"</a>"),$(d.seat).find(".avatar").css("background-image",'url("'+c.avatar_url+'")'),$(d.seat).find(".action-sit").hide(),$(d.seat).removeClass("dead"),!f.is_game_started&&c.name==a&&$(d.seat).find(".action-stand").show(),f.is_game_started&&(c.name==a&&$("#game-forfeit").show(),$("#game-endturn").show(),$("#turn-timer-box").show());var g=$.parseJSON(c.medals_json);$.each(g,function(a,b){var c=$(d.seat).find(".medal")[a],f=e(b);if(f.url==null)return;$(c).css("background","url('"+f.url+"') transparent");var g=$(c).data("tooltip");g!=null?(g.enable(),g.options.title=f.name):$(c).tooltip({html:!1,title:f.name,trigger:"hover"})}),$(d.seat).show()},this.emptySeat=function(a){var b=f._seats[a];b.player=null,$(b.seat).find(".name").html(""),$(b.seat).find(".avatar").css("background-image",""),$(b.seat).find(".place").html(""),$(b.seat).find(".points").html(""),$(b.seat).find(".delta_points").html(""),$(b.seat).find(".lands").html(""),$(b.seat).find(".stats").hide(),$(b.seat).find(".action-sit").show(),$(b.seat).find(".action-stand").hide(),$(b.seat).addClass("dead"),$(b.seat).removeClass("active");var c=$(b.seat).find(".medal");$(c).css("background",""),$.each($(c),function(a,b){var c=$(b).data("tooltip");c!=null&&c.disable()})};if(c!=null)for(i=0;i<c.length;i++)player=c[i],player.state!="dead"&&this.occupySeat((player.seat_id-1).toString(),player);if(!d){var f=this;$.each(this._seats,function(a,b){b.player==null&&$(f._seats[a].seat).find(".action-sit").show()})}}function Settings(a){var b=this;this.elementId=a,this._modal=$("#"+this.elementId),this.setupSettingsModal(),this._modal.on("show",function(){!!$(b._modal[0]).is(":visible")})}function SoundManager(){var a=!0;this.sounds=new Array,this.init=function(){this.ext="";var a=new Audio;a.canPlayType("audio/mpeg")&&(this.ext=".mp3"),a.canPlayType("audio/ogg")&&(this.ext=".ogg")},this.soundsToggle=function(b){a=b},this.play=function(b){if(!a)return;var c=null;switch(b){case"game_start":c=new Audio("/sounds/start2"+this.ext);break;case"sound_click":c=new Audio("/sounds/click"+this.ext);break;case"my_turn":c=new Audio("/sounds/turn"+this.ext);break;case"loss_roll":c=new Audio("/sounds/loss"+this.ext);break;case"win_roll":c=new Audio("/sounds/win"+this.ext);break;case"roll":return;default:return}c.play()}}function TurnTimer(a,b){var c=this;this._seat=a,this._bar=$($(a).find(".turn_progress")[0]),this._default_width=this._bar.width(),this._duration=b,this._timer=null}function WarSocial(){var a=-1,b=-1,c=[],d=null,e=!1,f=null,g=undefined,h=undefined;this.getPlayerList=function(){return c},this.getCurrentPlayerId=function(){return b},this.setCurrentPlayerId=function(a){b=a!=undefined?a:-1},this.getMap=function(){return d},this.getCanInteract=function(){return e},this.setCanInteract=function(a){e=a!=undefined&&a.constructor===Boolean?a:!1},this.getUserId=function(){return a},this.setUserId=function(b){a=b},this.getDiceBox=function(){return f},this.setAttackFrom=function(a){if(a==undefined||this.getMap().find_land_by_id(a)!=null)g=a},this.getAttackFrom=function(){return g},this.setAttackTo=function(a){if(a==undefined||this.getMap().find_land_by_id(a)!=null)h=a},this.getAttackTo=function(){return h},f=new DiceBox,this.create_map=function(a){d=new Map(a.width,a.height,a.land_id_tiles)},this.create_playerList=function(a,b){c=[];for(var d in a)if(a[d]!=null&&a[d]!=undefined&&a[d].player_id!=undefined){var e=!1;b!=undefined&&a[d].player_id==b&&(e=!0);var f=a[d].seat_id==undefined?a[d].player_id:a[d].seat_id;c.push(new Player(a[d].player_id,e,a[d].color,f)),console.log("playerList : "+c[c.length-1].getSeatId()),a[d].is_turn&&this.nextTurn(a[d].player_id)}}}ChatBox.prototype.setupChatBox=function(){},ChatBox.prototype.addChatLine=function(a,b){var c=this._seats.getColorOrNil(a);c=c==null?"black":c,this._tbody.append($('<tr><td><span style="color: '+c+';"><b>'+a+"</b></span>: "+b+"</td></tr>")),this._chatwindow.animate({scrollTop:this._chatwindow.prop("scrollHeight")},300)},ChatBox.prototype.addServerMessage=function(a){var b="green";this._tbody.append($('<tr><td class="well well-small"><span style="color: '+b+';">'+a+"</span></td></tr>")),this._chatwindow.animate({scrollTop:this._chatwindow.prop("scrollHeight")},300)};var global_game_name,global_init_data;GameLog.prototype.setupGameLog=function(){},GameLog.prototype.logGameStarted=function(){this._tbody.append($("<tr><td><div><b>Game started!</b></div></td></tr>")),this._logwindow.animate({scrollTop:this._logwindow.prop("scrollHeight")},300)},GameLog.prototype.logTurnChange=function(a){var b=this._seats.getColorOrNil(a);b=b==null?"black":b,this._tbody.append($('<tr><td><div class="divider"></div></td></tr>')),this._tbody.append($('<tr><td><div><span style="color:{0};"><b>{1}</span>&apos;s turn</b></div></td></tr>'.f(b,a))),this._logwindow.animate({scrollTop:this._logwindow.prop("scrollHeight")},300)},GameLog.prototype.logGameWinner=function(a){var b=this._seats.getColorOrNil(a);b=b==null?"black":b,this._tbody.append($('<tr><td><div><span style="color:{0};"><b>{1}</span> is the winner!</b></div></td></tr>'.f(b,a))),this._logwindow.animate({scrollTop:this._logwindow.prop("scrollHeight")},300)},GameLog.prototype.logAttack=function(a){var b=[],c=0;$.each(a.attack_info.attacker_roll,function(){b.push(this.toString()),c+=this});var d=b.join(",");b=[];var e=0;$.each(a.attack_info.defender_roll,function(){b.push(this.toString()),e+=this});var f=b.join(","),g=a.attack_info.defender_player_id,h=null;$.each(a.players,function(){this.player_id==g&&(h=this.name)});var i=this._seats.getColorOrNil(h);i=i==null?"black":i;var j=c>e?"defeated":"defended",k=a.attack_info.attacker_roll.length.toString()+"v"+a.attack_info.defender_roll.length.toString(),l="{0} to {1}".f(c,e),m="({0} to {1})".f(d,f);this._tbody.append($('<tr><td><div><span style="color:{0};"><b>{1}</b></span> {2} {3}, {4}, {5}</div></td></tr>'.f(i,h,j,k,l,m))),this._logwindow.animate({scrollTop:this._logwindow.prop("scrollHeight")},300)},Land.prototype.isAdjacentTo=function(a){return a.constructor===Number&&this.getAdjacentLandIds().indexOf(a)!=-1?!0:!1},Land.prototype.toString=function(){return"[Land]"},Map.prototype.toString=function(){return"[Map]"},Map.prototype.createLandList=function(a){var b=new Array;if(a==undefined)return b;var c=a.length,d=0;while(d<c)a[d]!=0&&b[a[d]]==undefined&&(b[a[d]]=new Land(a[d])),d++;return b},Map.prototype.find_adjacent_lands_from_tiles=function(a,b,c){for(var d=0;d<c;d++)for(var e=0;e<b;e++){var f=d*b+e;if(a[f]==0)continue;if(e%2==1&&d==c-1)continue;var g=undefined;e!=b-1&&(g=e%2==0?f+1:f+1+b);var h=undefined;e!=0&&(h=e%2==0?f-1:f-1+b);var i=undefined;d!=c-1&&(i=f+b),h!=undefined&&a[f]!=a[h]&&a[h]!=0&&(this.find_land_by_id(a[f]).addAdjacentLandId(a[h]),this.find_land_by_id(a[h]).addAdjacentLandId(a[f])),g!=undefined&&a[f]!=a[g]&&a[g]!=0&&(this.find_land_by_id(a[f]).addAdjacentLandId(a[g]),this.find_land_by_id(a[g]).addAdjacentLandId(a[f])),i!=undefined&&a[f]!=a[i]&&a[i]!=0&&(this.find_land_by_id(a[f]).addAdjacentLandId(a[i]),this.find_land_by_id(a[i]).addAdjacentLandId(a[f]))}},Map.prototype.find_land_by_id=function(a){if(a!=undefined){var b=this.getLandList();return b[a]}return null},Map.prototype.find_lands_by_player_id=function(a){var b=[];if(a!=undefined&&a.constructor===Number){var c=0;while(c<this.getLandList().length)this.getLandList()[c]!=undefined&&this.getLandList()[c].getOwner()!=null&&this.getLandList()[c].getOwner().getId()==a&&b.push(this.getLandList()[c]),c++}return b},Map.prototype.claim=function(a,b,c){var d=this.find_land_by_id(a);d!=null&&(b instanceof Player||b==null)&&(d.setOwner(b),c!=undefined&&c.constructor===Number&&d.setTroops(c))},Map.prototype.free_land_owned_by=function(a){var b=[];if(a!=undefined&&a.constructor===Number){b=this.find_lands_by_player_id(a);var c=0;while(c<b.length)b[c].setOwner(null),c++}},Map.prototype.getLandPlayerList=function(){var a=[],b=this.getLandList(),c=0;while(c<b.length)b[c]&&(a[b[c].getId()]=b[c].getOwner()!=null?b[c].getOwner().getSeatId():0),c++;return a},Map.prototype.getLandByCoords=function(a,b){if(a==undefined||b==undefined||a.constructor!=Number||b.constructor!=Number)return null;if(a<0||b<0||a>this.getWidth()-1||b>this.getHeight())return null;var c=b*this.getWidth()+a;return this.getTiles()[c]},Map.prototype.getDeploymentLandList=function(){var a=[],b=this.getLandList(),c=0;while(c<b.length)b[c]&&(a[b[c].getId()]=new Array,a[b[c].getId()][0]=b[c].getTroops(),a[b[c].getId()][1]=b[c].getNewTroops()),c++;return a},Map.prototype.drawcanvas=function(a){a==undefined&&(a=!0),this.getMapCanvas().draw_canvas(this.getTiles(),this.getWidth(),this.getHeight(),this.getLandPlayerList(),this.getDeploymentLandList(),a)},Map.prototype.hilight_player_lands=function(a){var b=[];if(a!=undefined&&a.constructor===Number){b=this.find_lands_by_player_id(a);var c=0;this.getMapCanvas().unhilight_player_lands();while(c<b.length)this.getMapCanvas().hilight_player_land(this.getTiles(),this.getWidth(),this.getHeight(),b[c].getId()),c++}},Map.prototype.select=function(a,b){b?this.getMapCanvas().hilight_origin_land(this.getTiles(),this.getWidth(),this.getHeight(),a):this.getMapCanvas().hilight_destination_land(this.getTiles(),this.getWidth(),this.getHeight(),a)},Map.prototype.unselect=function(a){a?this.getMapCanvas().unhilight_origin_land():this.getMapCanvas().unhilight_destination_land()},MapCanvas.prototype.hexToR=function(a){return parseInt(this.cutHex(a).substring(0,2),16)},MapCanvas.prototype.hexToG=function(a){return parseInt(this.cutHex(a).substring(2,4),16)},MapCanvas.prototype.hexToB=function(a){return parseInt(this.cutHex(a).substring(4,6),16)},MapCanvas.prototype.cutHex=function(a){return a.charAt(0)=="#"?a.substring(1,7):a},MapCanvas.prototype.get_x_from_col=function(a){return this.getColWidth()*a+this.getCanvasMargin()},MapCanvas.prototype.get_y_from_row_col=function(a,b){var c=this.getRowHeight()*a+this.getCanvasMargin();return b%2==1&&(c+=this.getRowHeight()/2),c},MapCanvas.prototype.getTileIndexFromCoords=function(a,b){if(a!=undefined&&a.constructor===Number&&b!=undefined&&b.constructor===Number){var c=Math.floor((a-this.getCanvasMargin())/this.getColWidth()),d=c%2==1?this.getRowHeight()/2:0,e=Math.floor((b-this.getCanvasMargin()-d)/this.getRowHeight());return[c,e]}return null},MapCanvas.prototype.draw_shape=function(a,b,c,d,e){c.beginPath(),c.moveTo(a+this.getShapePointX()[0],b+this.getShapePointY()[0]);for(var f=1;f<6;f++)c.lineTo(a+this.getShapePointX()[f],b+this.getShapePointY()[f]);c.fillStyle=d,c.fill(),e!=null&&(c.strokeStyle=e,c.lineWidth=1,c.stroke()),c.closePath()},MapCanvas.prototype.draw_border=function(a,b,c,d,e,f){c.lineWidth=f;for(var g=0;g<6;g++)d>>g&!0&&(c.beginPath(),c.strokeStyle=e,c.moveTo(a+this.getShapePointX()[g],b+this.getShapePointY()[g]),c.lineTo(a+this.getShapePointX()[g+1],b+this.getShapePointY()[g+1]),c.stroke(),c.closePath())},MapCanvas.prototype.draw_tile=function(a,b,c,d,e){var f,g,h,i=this.getPlayerColourStroke()[c],j=this.getPlayerColourFill()[c],k=document.getElementById("canvas_map"),l=k.getContext("2d");l.lineCap="round",g=this.get_x_from_col(b),h=this.get_y_from_row_col(a,b),l.save(),this.draw_shape(g,h,l,j,j),l.clip(),this.draw_border(g,h,l,e&parseInt("100011",2),"rgba(255, 255, 255, 0.25)",2),this.draw_border(g,h,l,e&parseInt("011100",2),"rgba(0, 0, 0, 0.25)",2),this.draw_border(g,h,l,d,"rgba(255, 255, 255, 0.75)",6),this.draw_border(g,h,l,d,i,4),l.restore()},MapCanvas.prototype.draw_shadow=function(a,b,c,d){var e=d.getContext("2d"),f,g,h=1,i=0,j="#444";e.shadowOffsetX=0,e.shadowOffsetY=3,e.shadowBlur=7,e.shadowColor="rgba(0,0,0,0.4)";var k=document.getElementById("canvas_map"),l=k.getContext("2d");e.drawImage(k,0,0,k.width,k.height)},MapCanvas.prototype.draw_texture=function(a,b,c,d,e){var f=d.getContext("2d"),g,h,i=f.createPattern(e,"repeat");if(i!=null)for(g=0;g<c;g++)for(h=0;h<b;h++)if(a[g*b+h]!=0){var j=this.get_x_from_col(h),k=this.get_y_from_row_col(g,h);this.draw_shape(j,k,f,i)}},MapCanvas.prototype.get_adjacent_tile_id=function(a,b,c,d,e,f){var g,h;switch(f){case 0:g=a-1,h=b;break;case 1:g=a-1,h=b+1;break;case 2:g=a,h=b+1;break;case 3:g=a+1,h=b;break;case 4:g=a,h=b-1;break;case 5:g=a-1,h=b-1}return b%2==1&&(f==1||f==2||f==4||f==5)&&g++,h>=d||h<0||g>=e||g<0?null:c[g*d+h]},MapCanvas.prototype.draw_tiles=function(a,b,c,d){var e,f;for(e=0;e<c;e++)for(f=0;f<b;f++)if(a[e*b+f]!=0){var g=a[e*b+f],g=a[e*b+f],h=0,i=0;for(var j=0;j<6;j++){var k=this.get_adjacent_tile_id(e,f,a,b,c,j);k!=g&&(d[k]!=d[g]?h|=1<<j:i|=1<<j)}this.draw_tile(e,f,d[g],h,i)}},MapCanvas.prototype.clear_all=function(){var a=document.getElementById("canvas_map");if(a!=null){var b=a.getContext("2d");b.clearRect(0,0,a.width,a.height)}},MapCanvas.prototype.eraseMap=function(){this.clearDice(),this.clear_all(),canvas=document.getElementById("canvas_shadow"),canvas!=null&&(ctx=canvas.getContext("2d"),ctx.clearRect(0,0,canvas.width,canvas.height)),this.set_first_display(!1)},MapCanvas.prototype.draw_canvas=function(a,b,c,d,e,f){this.draw_tiles(a,b,c,d,document.getElementById("canvas_map")),this.get_first_display()&&(this.draw_shadow(a,b,c,document.getElementById("canvas_shadow")),this.calculate_dice_positions(a,b,c)),this.draw_texture(a,b,c,document.getElementById("canvas_map"),document.getElementById("pattern")),this.add_dice(a,b,c,e,d,f),this.set_first_display(!1)},MapCanvas.prototype.calculate_dice_positions=function(a,b,d){var e=[],f=[];for(r=0;r<d;r++)for(c=0;c<b;c++){var g=a[r*b+c];if(e[g]==null&&g!=0){var h=this.get_centre_row_col(a,b,d,g),i=new Object;i.x=this.get_x_from_col(h[1]),i.y=this.get_y_from_row_col(h[0],h[1]),i.id=g,e[g]=i}}for(element in e)f.push(e[element]);f.sort(function(a,b){return a.y==b.y?a.x-b.x:a.y-b.y}),this.setLandDicePositions(f),this.create_dice_layers()},MapCanvas.prototype.create_dice_layers=function(){var a=this.getLandDicePositions(),b=$("#dice_container"),c={};for(var d=0;d<a.length;d++){var e=$(document.createElement("canvas")).attr({id:"dice_canvas_"+a[d].id,width:b.width(),height:b.height()}).css({position:"absolute",left:"0",top:"0","z-index":d});b.append(e),c[a[d].id]=$("#dice_canvas_"+a[d].id)[0]}this.setDiceCanvasList(c)},MapCanvas.prototype.get_centre_row_col=function(a,b,c,d){var e,f,g=new Array,h=0,i=new Array;for(e=0;e<c;e++){var j=0;for(f=0;f<b;f++)a[e*b+f]==d&&j++;j>h?(h=j,g=new Array,g.push(e)):j==h&&g.push(e)}i[0]=g[Math.round(g.length/2)-1];for(f=0;f<b;f++)if(a[i[0]*b+f]==d){i[1]=f+Math.round(h/2)-1;break}return i},MapCanvas.prototype.add_dice=function(a,b,c,d,e,f){f==undefined&&(f=!0);var g=4,h=11,i=13,j=7,k=0,l=1,m=0,n,o,p,q,r=this,s=this.get_first_display(),t=new Array,u=0,v=this.getDiceCanvasList(),w=this.getLandDicePositions();for(q=0;q<w.length;q++){var x=w[q].id;if(x!=0&&d[x][k]>0){var y=v[x],z=y.getContext("2d"),A=w[q].x,B=w[q].y,C=d[x][k],D=d[x][l];z.clearRect(0,0,y.width,y.height);var E=Math.floor(e[x]%6+1);for(p=0;p<C;p++){var F=Math.floor(p/g),G=p%g,H=!1;G==0&&(H=!0);var I=!s;if(p<C-D||!f)I=!1;if(!I)this.draw_dice(A+i*F,B-h*G+j*F,E,H,z,e[x]);else{var J=new Object;J.x=A+i*F,J.y=B-h*G+j*F,J.val=E,J.shadow=H,J.ctx=z,J.colour_id=e[x],t[u]=J,u++}}}}t.length>0&&(this.setMapDiceTimer(),this.setDelayedDiceArray(t))},MapCanvas.prototype.show_new_die=function(){var a=this.getDelayedDiceArray();a==undefined&&clearInterval(this.getMapDiceTimer()),a!=undefined&&a.length>0&&(this.draw_dice(a[0].x,a[0].y,a[0].val,a[0].shadow,a[0].ctx,a[0].colour_id),a.splice(0,1),this.setDelayedDiceArray(a),a.length<=0&&clearInterval(this.getMapDiceTimer())),SoundManager.play("sound_click")},MapCanvas.prototype.clearDice=function(){var a=this.getDiceCanvasList(),b=this.getLandDicePositions();for(j=0;j<b.length;j++){var c=b[j].id;if(c!=0){var d=a[c],e=d.getContext("2d");e.clearRect(0,0,d.width,d.height)}}},MapCanvas.prototype.draw_dice=function(a,b,c,d,e,f){var g="dice",h="dice_shadow",i=4,j=-6,k=20,l=20,m=i-2,n=j+4,o=$("#"+(g+c))[0];if(d){var p=$("#"+h)[0];e.drawImage(p,a+m,b+n)}var q=$("#canvas_dice")[0],r=10,s=q.getContext("2d"),t=this.getPlayerColourFill()[f],u=.4,v="rgba("+this.hexToR(t)+","+this.hexToG(t)+","+this.hexToB(t)+","+u+")";q.width=k+r*2,q.height=l+r*2,s.fillStyle=v,s.drawImage(o,i+r,j+r),s.globalCompositeOperation="lighter",s.fillRect(i+r,j+r,k,l),s.globalCompositeOperation="destination-in",s.drawImage(o,i+r,j+r),e.drawImage(q,a-r,b-r),s.clearRect(0,0,q.width,q.height)},MapCanvas.prototype.hilight_land=function(a,b,c,d,e,f){var g=e.getContext("2d"),h=document.createElement("canvas"),i=h.getContext("2d"),j,k,l,m,n,o;l=m=n=o=-1,h.width=e.width,h.height=e.height,i.shadowBlur=5,i.shadowColor="rgba(0,0,0,1.0)";for(j=0;j<c;j++)for(k=0;k<b;k++)if(a[j*b+k]==d){var p=this.get_x_from_col(k),q=this.get_y_from_row_col(j,k);if(l==-1||l>p)l=p;if(m==-1||m>q)m=q;n<p&&(n=p),o<q&&(o=q),this.draw_shape(p,q,i,"#000000","#000000")}o+=this.getRowHeight(),n+=this.getShapeWidth(),l-=i.shadowBlur,m-=i.shadowBlur,n+=i.shadowBlur,o+=i.shadowBlur;var r=l+(n-l)/2,s=m+(o-m)/2,t;n-l>o-m?t=(n-l)/2:t=(o-m)/2;var u=g.createRadialGradient(r,s,0,r,s,t);u.addColorStop(0,"rgba(255, 255, 255,"+f+")"),u.addColorStop(1,"rgba(255, 255, 255,"+f/2+")"),g.globalCompositeOperation="source-out",g.drawImage(h,0,0),g.globalCompositeOperation="source-in",g.fillStyle=u,g.fillRect(l,m,n-l,o-m)},MapCanvas.prototype.hilight_player_land=function(a,b,c,d){var e=document.getElementById("canvas_hilight_player");if(e!=null){var f=e.getContext("2d"),g=document.createElement("canvas");g.width=e.width,g.height=e.height,d!=0&&(this.hilight_land(a,b,c,d,g,.5),f.drawImage(g,0,0)),this.unhilight_origin_land()}},MapCanvas.prototype.unhilight_player_lands=function(){var a=document.getElementById("canvas_hilight_player");if(a!=null){var b=a.getContext("2d");b.clearRect(0,0,a.width,a.height)}},MapCanvas.prototype.hilight_origin_land=function(a,b,c,d){d!=0&&this.hilight_land(a,b,c,d,document.getElementById("canvas_hilight_origin"),.9)},MapCanvas.prototype.hilight_destination_land=function(a,b,c,d){d!=0&&this.hilight_land(a,b,c,d,document.getElementById("canvas_hilight_destination"),.9)},MapCanvas.prototype.unhilight_origin_land=function(){var a=document.getElementById("canvas_hilight_origin"),b=a.getContext("2d");b.clearRect(0,0,a.width,a.height)},MapCanvas.prototype.unhilight_destination_land=function(){var a=document.getElementById("canvas_hilight_destination"),b=a.getContext("2d");b.clearRect(0,0,a.width,a.height)},Player.prototype.toString=function(){return"[Player]"},Seats.prototype.clear=function(){var a=this;$.each(this._seats,function(b,c){$(c.seat).removeClass("dead"),a.emptySeat(b)}),$("#game-forfeit").hide(),$("#game-endturn").hide(),$("#turn-timer-box").hide(),this.is_game_started=!1},Seats.prototype.sit=function(a){var b=this;$.each(this._seats,function(c,d){if(d.player==null)return b.occupySeat(c,a),!1})},Seats.prototype.game_started=function(){var a=this;this.is_game_started=!0,$.each(this._seats,function(b,c){c.seat.find(".action-sit").hide(),c.seat.find(".action-stand").hide(),c.player!=null&&c.player.name==a.who_am_i&&$("#game-forfeit").show(),$("#game-endturn").show(),$("#turn-timer-box").show()})},Seats.prototype.update_player_data=function(a){var b=this;$.each(a,function(a,c){var d=c.seat_id-1,e=b._seats[d.toString()],f=e.seat;c.state=="dead"?$(f).addClass("dead"):($(f).show(),b.is_game_started&&$(f).find("div.stats").show());var g=c.delta_points.toString();c.delta_points!=0&&(g=c.delta_points>0?"+"+g:"-"+g),convert_place_to_string=function(a){switch(a){case 1:return"1st";case 2:return"2nd";case 3:return"3rd";case 4:return"4th";case 5:return"5th";case 6:return"6th";case 7:return"7th";default:return""}},$(f).find(".place").html(convert_place_to_string(c.place)),$(f).find(".points").html(c.current_points.toString()+" ("+g+")"),$(f).find(".dice").html(c.dice_count.toString()+" (+"+c.reserves.toString()+")"),$(f).find(".lands").html(c.land_count.toString())})},Seats.prototype.turn_start=function(a){this.is_game_started=!0
;var b=this;$.each(this._seats,function(c,d){if(d.player!=null&&d.player.player_id==a.player_id){d.seat.addClass("active"),a.name==b.who_am_i?$("#game-endturn").removeClass("disabled"):$("#game-endturn").addClass("disabled"),b.timer.restart(),$("#turn-username").html(d.player.name);var e=$("div.avatar",d.seat).first().css("background-color");$("#turn-timer-box .bar").css("background-color",e)}else d.seat.removeClass("active")})},Seats.prototype.turn_timer_restart=function(a){this.timer.restart()},Seats.prototype.stand=function(a){var b=this;$.each(this._seats,function(c,d){d.player!=null&&d.player.player_id==a.player_id&&b.emptySeat(c)})},Seats.prototype.getColorOrNil=function(a){var b=this,c=["#f8af01","#3760ae","#c22b2b","#5fb61f","#603bb3","#27a7b2","#ad3bac"],d=null;return $.each(this._seats,function(b,e){if(e.player!=null&&e.player.name==a)return d=c[parseInt(b)],!1}),d},Settings.prototype.setupSettingsModal=function(){},Array.prototype.indexOf||(Array.prototype.indexOf=function(a){var b=this.length,c=Number(arguments[1])||0;c=c<0?Math.ceil(c):Math.floor(c),c<0&&(c+=b);for(;c<b;c++)if(c in this&&this[c]===a)return c;return-1}),String.prototype.format=String.prototype.f=function(){var a=this,b=arguments.length;while(b--)a=a.replace(new RegExp("\\{"+b+"\\}","gm"),arguments[b]);return a};var maxchannels=10,SoundManager=new SoundManager;TurnTimer.prototype.restart=function(){var a=this,b=0;this._bar.width(this._default_width),this.stop(),this._timer=window.setInterval(function(){b++,a._bar.width(a._default_width-b/a._duration*a._default_width),b>=a._duration&&clearInterval(a._timer)},1e3)},TurnTimer.prototype.stop=function(){clearInterval(this._timer),this._bar.width(this._default_width)},WarSocial.prototype.init=function(a){this.reset(),this.create_map(a.map_layout),this.setUserId(a.who_am_i),this.create_playerList(a.players,a.who_am_i),this.deploy(a.deployment);for(var b=0;b<a.players.length;b++)a.players[b].is_turn&&this.nextTurn(a.players[b].player_id);this.addMouseListener(),SoundManager.init()},WarSocial.prototype.addMouseListener=function(){var a=$("#stage");a!=null&&a!=undefined&&!this.getCanInteract()&&(a.bind("click",this.clickOnCanvas),this.setCanInteract(!0))},WarSocial.prototype.removeMouseListener=function(){var a=$("#stage");a!=null&&a!=undefined&&this.getCanInteract()&&(a.unbind("click"),this.setCanInteract(!1))},WarSocial.prototype.clickOnCanvas=function(a){var b=$("#stage");if(b!=null&&b!=undefined)var c=a.pageX-$(this).offset().left,d=a.pageY-$(this).offset().top;game!=null&&game.userClicksOnLand(c,d)},WarSocial.prototype.userClicksOnLand=function(a,b){if(this.getUserId()!=-1&&this.getAttackTo()==undefined&&this.getUserId()==this.getCurrentPlayerId()){var c=this.getMap().getMapCanvas().getTileIndexFromCoords(a,b),d=this.getMap().getLandByCoords(c[0],c[1]),e=this.getMap().find_land_by_id(d),f=e!=null&&e.getOwner()!=null?e.getOwner():null,g=this.getAttackFrom(),h=this.getAttackTo();e!=null&&(g!=undefined||e==null||f==null||f.getId()==this.getUserId())&&(g==undefined&&e!=null&&f!=null&&f.getId()==this.getUserId()&&e.getTroops()<=1||(g==undefined&&e!=null&&f!=null&&f.getId()==this.getUserId()?(this.getMap().select(d,!0),this.setAttackFrom(d)):g!=undefined&&g==d?(this.getMap().unselect(!0),this.setAttackFrom(undefined)):g!=undefined&&h==undefined&&f==this.getMap().find_land_by_id(g).getOwner()?e.getTroops()>1&&(this.getMap().unselect(!0),this.getMap().select(d,!0),this.setAttackFrom(d)):g!=undefined&&h==undefined&&e!=null&&(!e.isAdjacentTo(g)||(this.setAttackTo(d),this.getMap().select(d,!1),this.request_attack()))))}},WarSocial.prototype.request_attack=function(){attack_out(this.getAttackFrom(),this.getAttackTo()),SoundManager.play("roll")},WarSocial.prototype.attack=function(a){this.removeMouseListener();var b=this.getMap().find_land_by_id(a.attack_info.attacker_land_id).getOwner(),c=this.getMap().find_land_by_id(a.attack_info.defender_land_id).getOwner(),d=0,e=0;b!=null&&(d=b.getId()),c!=null&&(e=c.getId());var f=this;d!=this.getUserId()&&(this.getMap().select(a.attack_info.attacker_land_id,!0),setTimeout(function(){f.getMap().select(a.attack_info.defender_land_id,!1)},200));var g=this.getDiceBox();g!=null&&c!=null?g.show_dice_box(a.attack_info.attacker_roll,a.attack_info.defender_roll,b.getSeatId(),c.getSeatId()):g!=null&&g.show_dice_box(a.attack_info.attacker_roll,a.attack_info.defender_roll,b.getSeatId(),0),setTimeout(function(){f.deploy(a.deployment_changes,!1)},400);var h=0;$.each(a.attack_info.attacker_roll,function(){h+=this});var i=0;$.each(a.attack_info.defender_roll,function(){i+=this}),h>i?SoundManager.play("win_roll"):SoundManager.play("loss_roll")},WarSocial.prototype.deploy=function(a,b){b==undefined&&(b=!0);var c=this.getMap();for(var d in a)if(a[d].deployment!=undefined&&a[d].deployment.constructor===Number&&a[d].land_id!=undefined&&a[d].land_id.constructor===Number){var e=this.find_by_player_by_id(a[d].player_id);c.claim(a[d].land_id,e,a[d].deployment)}this.clear_all(),c.drawcanvas(b),next_turn(this.getCurrentPlayerId())},WarSocial.prototype.nextTurn=function(a){if(a!=undefined){this.removeMouseListener(),this.setCurrentPlayerId(a);var b=this.getMap();b.hilight_player_lands(a),this.addMouseListener()}},WarSocial.prototype.playerQuit=function(a){var b=this.find_by_player_by_id(a);if(b!=null){var c=this.getMap().find_lands_by_player_id(a);for(var d=0;d<c.length;d++)c[d].setOwner(null)}this.removePlayer(a),this.deploy(null)},WarSocial.prototype.find_by_player_by_id=function(a){if(a!=undefined){var b=0,c=this.getPlayerList();while(b<c.length){if(c[b].getId()==a)return c[b];b++}}return null},WarSocial.prototype.removePlayer=function(a){var b=0,c=this.getPlayerList();while(b<c.length){if(c[b].getId()==a){c.splice(b,1);return}b++}},WarSocial.prototype.reset=function(){this.getMap()!=null&&this.getMap()!=undefined&&(this.getMap().getMapCanvas().eraseMap(),this.clear_all()),this.removeMouseListener(),this.setUserId(-1),this.setCurrentPlayerId(-1)},WarSocial.prototype.clear_all=function(){this.getMap().getMapCanvas().clear_all(),this.getMap().unselect(!0),this.getMap().unselect(!1),this.setAttackFrom(undefined),this.setAttackTo(undefined)},WarSocial.prototype.toggle_dice=function(a){$("#dice_container").toggle(a)},WarSocial.prototype.toggle_sounds=function(a){SoundManager.soundsToggle(a)};